import http from 'http';
import fs from 'fs';
import * as dotenv from 'dotenv';
import { URL } from 'url';
dotenv.config();

import IssuerDataFetcher from './lib/IssuerDataFetcher.js';
import TokenRequestCreator from './lib/TokenRequestCreator.js';
import TokenRedemption from './lib/TokenRedemption.js';

// --- CONFIGURATION MAPPING ---
const ISSUER_MAP = {
    'cf_demo': process.env.ISSUER_CF_DEMO,
    'cf_sat':  process.env.ISSUER_CF_SAT,
    'fastly':  process.env.ISSUER_FASTLY
};

const DEFAULT_ISSUER = process.env.TOKEN_DICT_URL;

const issuerDataFetcher = new IssuerDataFetcher();
const tokenRequestCreator = new TokenRequestCreator();
const tokenRedemption = new TokenRedemption();

if (!DEFAULT_ISSUER) {
    console.error('Error: Please configure .env file with issuer URLs.');
    process.exit(1);
}

http.createServer(async function (req, res) {
    try {
        const currentUrl = new URL(req.url, `http://${req.headers.host}`);
        
        // DEBUG LOGGING
        console.log('\n------------------------------------------------');
        console.log(`[DEBUG] Incoming Request: ${req.method}`);
        console.log(`[DEBUG] Full URL: ${currentUrl.href}`);
        console.log('------------------------------------------------');

        const issuerKey = currentUrl.searchParams.get('issuer');

        // Logic: If root "/" with NO key and NO auth header, show selection screen.
        if (currentUrl.pathname === '/' && !issuerKey && !req.headers['authorization']) {
            try {
                let html = fs.readFileSync("html/index.html", "utf8");
                res.writeHead(200, { 'Content-Type': 'text/html; charset=utf-8' });
                res.end(html);
                return;
            } catch (e) {
                console.log("index.html missing");
            }
        }

        let targetIssuerUrl = ISSUER_MAP[issuerKey] || DEFAULT_ISSUER;
        console.log(`> Key: "${issuerKey}" | Using URL: ${targetIssuerUrl}`);

        const issuerInfo = await issuerDataFetcher.fetchIssuerData(targetIssuerUrl);

        // --- VALIDATION LOGIC ---
        let validationResult = { isValid: false };
        if ('authorization' in req.headers) {
            validationResult = tokenRedemption.validateAuthToken(issuerInfo, req.headers['authorization']);
        }

        if (validationResult.isValid) {
            // CASE 200: SUCCESS
            console.log('200 - Authenticated Request');
            let html = fs.readFileSync("html/success200.html", "utf8");
            html = html.replace('AUTH_HEADER', req.headers['authorization']);
            html = html.replace('TOKEN_INFO_JSON', JSON.stringify(validationResult.tokenData, null, 4));
            res.writeHead(200, { 'Content-Type': 'text/html; charset=utf-8' });
            res.end(html);

        } else {
            // CASE 401: CHALLENGE
            console.log('401 - Sending Challenge for: ' + issuerInfo.issuer_name);

            const tokenRequest = tokenRequestCreator.createTokenRequest(
                issuerInfo.issuer_name, 
                process.env.INCLUDE_RANDOM_NONCE || true, 
                process.env.ORIGIN_SCOPE
            );
            
            tokenRedemption.registerTokenRequestForRedemption(Buffer.from(tokenRequest, 'base64'));
            
            // --- MODIFIED HERE: REMOVED token-issuer-directory ---
            const challengeString = `PrivateToken challenge=${tokenRequest}, token-key=${issuerInfo.issuer_public_key_base64}`;

            let html = fs.readFileSync("html/challenge401.html", "utf8");
            html = html.replace('CHALLENGE_STRING_VAL', challengeString);
            html = html.replace('ISSUER_NAME_VAL', issuerInfo.issuer_name);
            html = html.replace('ORIGIN_SCOPE_VAL', process.env.ORIGIN_SCOPE || "N/A");
            html = html.replace('TOKEN_KEY_VAL', issuerInfo.issuer_public_key_base64);

            if (validationResult.error) {
                html = html.replace('ERROR_MSG', `<p style="color:red">Validation Failed: ${validationResult.error}</p>`);
            } else {
                html = html.replace('ERROR_MSG', '');
            }

            res.writeHead(401, { 
                'Content-Type': 'text/html; charset=utf-8',
                'WWW-Authenticate': challengeString 
            });
            res.end(html);
        }

    } catch (error) {
        console.error("Critical Server Error:", error);
        res.writeHead(500);
        res.end("Internal Server Error");
    }

}).listen(process.env.NODE_PORT || 8080);
